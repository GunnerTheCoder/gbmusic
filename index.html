<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Music Reviews</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    .controls {
      margin-bottom: 20px;
    }
    .controls select,
    .controls input {
      padding: 8px;
      font-size: 16px;
      margin-right: 10px;
    }
    .tabs {
      margin-bottom: 20px;
    }
    .tab-button {
      padding: 10px 20px;
      cursor: pointer;
      border: 1px solid #ccc;
      margin-right: 5px;
      background: #f9f9f9;
    }
    .tab-button.active {
      background: #ddd;
      font-weight: bold;
    }
    /* Container for each review with dropdown */
    .review-container {
      margin-bottom: 15px;
    }
    /* Pill style for the visible review card */
    .review-card {
      display: flex;
      align-items: center;
      border: 1px solid #ccc;
      border-radius: 30px;
      padding: 10px 15px;
      background-color: #f9f9f9;
    }
    .review-cover {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }
    .review-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .review-title {
      font-weight: bold;
      font-size: 16px;
      margin: 0;
      padding: 0;
    }
    .review-artist {
      font-size: 14px;
      color: #666;
      margin: 0;
      padding: 0;
    }
    /* Container for the speedometer gauge */
    .review-speedometer {
      width: 50px;
      height: 50px;
      margin-left: 10px;
    }
    /* Dropdown toggle button */
    .dropdown-toggle {
      cursor: pointer;
      padding: 5px;
      font-size: 18px;
      margin-left: 10px;
    }
    /* Hidden dropdown content (expanded on toggle) */
    .dropdown-content {
      display: none;
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 10px 10px;
      padding: 10px 15px;
      background-color: #fff;
    }
    .dropdown-content.active {
      display: block;
    }
    /* Optional styling for embedded content */
    .spotify-embed {
      margin-bottom: 10px;
    }
    .detail-label {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Music Reviews</h1>
  
  <div class="controls">
    <select id="review-type">
      <option value="songs">Song Reviews</option>
      <option value="albums">Album Reviews</option>
      <option value="artists">Artist Reviews</option>
    </select>
    <input type="text" id="search-input" placeholder="Search by artist..." />
  </div>
  
  <div class="tabs">
    <button class="tab-button active" data-reviewer="gunner">Gunner</button>
    <button class="tab-button" data-reviewer="brady">Brady</button>
  </div>
  
  <div id="reviews-container"></div>

  <script>
    let reviewsData = {};
    let currentReviewer = 'gunner';
    let currentReviewType = 'songs'; // "songs", "albums", or "artists"

    const reviewTypeSelect = document.getElementById('review-type');
    const searchInput = document.getElementById('search-input');
    const reviewsContainer = document.getElementById('reviews-container');

    // Change JSON file when review type changes
    reviewTypeSelect.addEventListener('change', () => {
      currentReviewType = reviewTypeSelect.value;
      loadReviews();
    });

    // Switch reviewer tab
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        currentReviewer = button.getAttribute('data-reviewer');
        renderReviews();
      });
    });

    // Filter by artist name in search
    searchInput.addEventListener('input', renderReviews);

    // Load JSON file based on review type
    function loadReviews() {
      reviewsContainer.innerHTML = '<p>Loading reviews...</p>';
      let fileName = '';
      if (currentReviewType === 'songs') fileName = 'songs.json';
      else if (currentReviewType === 'albums') fileName = 'albums.json';
      else if (currentReviewType === 'artists') fileName = 'artists.json';

      fetch(fileName)
        .then(response => response.json())
        .then(data => {
          reviewsData = data;
          renderReviews();
        })
        .catch(err => {
          console.error('Error loading reviews:', err);
          reviewsContainer.innerHTML = '<p>Error loading reviews.</p>';
        });
    }

    // Fetch Spotify oEmbed details for thumbnail and embed HTML
    function fetchSpotifyDetails(spotifyLink, callback) {
      fetch('https://open.spotify.com/oembed?url=' + encodeURIComponent(spotifyLink))
        .then(res => res.json())
        .then(data => callback(null, data))
        .catch(err => callback(err, null));
    }

    // Create a speedometer gauge as an SVG element
    function createSpeedometer(rating, reviewer) {
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("width", "50");
      svg.setAttribute("height", "50");
      svg.setAttribute("viewBox", "0 0 36 36");

      // Background circle
      const bgCircle = document.createElementNS(svgNS, "path");
      bgCircle.setAttribute("d", "M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831");
      bgCircle.setAttribute("fill", "none");
      bgCircle.setAttribute("stroke", "#eee");
      bgCircle.setAttribute("stroke-width", "2");
      svg.appendChild(bgCircle);

      // Foreground progress circle
      const progressCircle = document.createElementNS(svgNS, "path");
      progressCircle.setAttribute("d", "M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831");
      progressCircle.setAttribute("fill", "none");
      const strokeColor = (reviewer === 'gunner') ? 'blue' : 'green';
      progressCircle.setAttribute("stroke", strokeColor);
      progressCircle.setAttribute("stroke-width", "2");
      // The circle's circumference is ~100 so we use rating directly.
      progressCircle.setAttribute("stroke-dasharray", `${rating}, 100`);
      // Rotate so progress starts at top.
      progressCircle.setAttribute("transform", "rotate(-90 18 18)");
      svg.appendChild(progressCircle);

      // Center text for rating
      const textEl = document.createElementNS(svgNS, "text");
      textEl.setAttribute("x", "18");
      textEl.setAttribute("y", "22");
      textEl.setAttribute("text-anchor", "middle");
      textEl.setAttribute("font-size", "8");
      textEl.textContent = rating;
      svg.appendChild(textEl);

      return svg;
    }

    // Render all reviews for the current reviewer and review type
    function renderReviews() {
      reviewsContainer.innerHTML = '';
      if (!reviewsData[currentReviewer]) return;

      const searchQuery = searchInput.value.toLowerCase();

      reviewsData[currentReviewer].forEach(review => {
        // Filter by artist name if search is active
        if (review.artist && !review.artist.toLowerCase().includes(searchQuery)) return;

        // Safety checks based on review type
        if (currentReviewType === 'songs' && !review.song) return;
        if (currentReviewType === 'albums' && !review.album) return;
        if (currentReviewType === 'artists' && !review.artistRating) return;

        // Create container that holds both the pill and the dropdown content.
        const container = document.createElement('div');
        container.className = 'review-container';

        // Create the pill (review card)
        const card = document.createElement('div');
        card.className = 'review-card';

        // Cover image element: use Spotify thumbnail if available; fallback placeholder.
        const coverImg = document.createElement('img');
        coverImg.className = 'review-cover';
        coverImg.src = 'https://via.placeholder.com/40';
        if (review.spotifyLink) {
          fetchSpotifyDetails(review.spotifyLink, (err, data) => {
            if (!err && data && data.thumbnail_url) {
              coverImg.src = data.thumbnail_url;
            }
          });
        }
        card.appendChild(coverImg);

        // Review info (title and, if applicable, artist)
        const info = document.createElement('div');
        info.className = 'review-info';
        let titleText = '';
        if (currentReviewType === 'songs') {
          titleText = review.song || '';
        } else if (currentReviewType === 'albums') {
          titleText = review.album || '';
        } else if (currentReviewType === 'artists') {
          titleText = review.artist || '';
        }
        const titleEl = document.createElement('p');
        titleEl.className = 'review-title';
        titleEl.textContent = titleText;
        info.appendChild(titleEl);

        // For songs and albums, show the artist name below the title.
        if (currentReviewType === 'songs' || currentReviewType === 'albums') {
          const artistEl = document.createElement('p');
          artistEl.className = 'review-artist';
          artistEl.textContent = review.artist || '';
          info.appendChild(artistEl);
        }
        card.appendChild(info);

        // Create the speedometer gauge for the rating.
        let ratingValue = 0;
        if (currentReviewType === 'songs') {
          ratingValue = review.songRating || 0;
        } else if (currentReviewType === 'albums') {
          ratingValue = review.albumRating || 0;
        } else if (currentReviewType === 'artists') {
          ratingValue = review.artistRating || 0;
        }
        const gaugeContainer = document.createElement('div');
        gaugeContainer.className = 'review-speedometer';
        gaugeContainer.appendChild(createSpeedometer(ratingValue, currentReviewer));
        card.appendChild(gaugeContainer);

        // Dropdown toggle button
        const toggleBtn = document.createElement('div');
        toggleBtn.className = 'dropdown-toggle';
        toggleBtn.textContent = '▼';
        card.appendChild(toggleBtn);

        container.appendChild(card);

        // Create dropdown content container for extra details.
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown-content';
        
        // If there is a Spotify link, show the embed.
        if (review.spotifyLink) {
          const spotifyContainer = document.createElement('div');
          spotifyContainer.className = 'spotify-embed';
          spotifyContainer.textContent = 'Loading Spotify embed...';
          fetchSpotifyDetails(review.spotifyLink, (err, data) => {
            if (!err && data && data.html) {
              spotifyContainer.innerHTML = data.html;
            } else {
              spotifyContainer.textContent = 'Spotify embed not available.';
            }
          });
          dropdown.appendChild(spotifyContainer);
        }

        // Show comments if available.
        if (review.comments) {
          const commentsEl = document.createElement('div');
          commentsEl.innerHTML = `<span class="detail-label">Comments:</span> ${review.comments}`;
          dropdown.appendChild(commentsEl);
        }

        container.appendChild(dropdown);

        // Toggle dropdown display on button click.
        toggleBtn.addEventListener('click', () => {
          dropdown.classList.toggle('active');
          toggleBtn.textContent = dropdown.classList.contains('active') ? '▲' : '▼';
        });

        reviewsContainer.appendChild(container);
      });
    }

    // Initial load
    loadReviews();
  </script>
</body>
</html>
